<!DOCTYPE html>
<html lang="PT-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INSPE√á√ÉO PRO V26 - ALERTAS REVISADOS</title>
    <style>
        :root {
            --bg: #022C22; --card-bg: #064E3B; --text: #F8FAFC;
            --primary: #10B981; --border: #059669;
            --status-purple: #A855F7; /* VENCIDO */
            --status-red: #EF4444;    /* < 15 DIAS */
            --status-orange: #F97316; /* 16-30 DIAS */
            --status-yellow: #FACC15; /* 31-60 DIAS */
            --status-green: #22C55E;  /* > 60 DIAS */
        }

        body, input, select, textarea, button, table { text-transform: uppercase; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; }
        
        #mainContent { padding: 10px; display: block; }
        .container { max-width: 100%; margin: 0 auto; }
        .card { background: var(--card-bg); padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 12px; }
        h2 { margin-top: 0; color: #FFF; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; margin-bottom: 10px; }

        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 12px; }
        .stat-box { padding: 8px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 0.65rem; border: 1px solid rgba(255,255,255,0.05); }

        .form-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 6px; margin-bottom: 5px; }
        input, button, select { padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: #022C22; color: WHITE; font-size: 0.68rem; width: 100%; box-sizing: border-box; }
        
        .manager-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 12px; }
        .tag-list { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
        .tag { background: #064E3B; border: 1px solid var(--primary); padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 5px; font-size: 0.6rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 5px; table-layout: auto; }
        th, td { text-align: left; padding: 4px 6px; border-bottom: 1px solid var(--border); font-size: 0.62rem; line-height: 1; }
        th { background: #022C22; color: #D1FAE5; vertical-align: top; white-space: nowrap; }

        .filter-row { font-size: 0.52rem; padding: 2px; background: #022C22; border: 1px solid #10B981; margin-top: 3px; color: white; height: 18px; width: 100%; box-sizing: border-box; }

        .status { padding: 2px 4px; border-radius: 3px; font-size: 0.55rem; font-weight: 900; color: #FFF; display: inline-block; min-width: 50px; text-align: center; }
        .aviso-vencido { background-color: var(--status-purple); }
        .aviso-vermelho { background-color: var(--status-red); }
        .aviso-laranja { background-color: var(--status-orange); }
        .aviso-amarelo { background-color: var(--status-yellow); color: #000 !important; }
        .status-ok { background-color: var(--status-green); }

        .btn-add { background: var(--primary); font-weight: bold; border: none; cursor: pointer; color: white; height: 100%; }
        .btn-sort { background: #F59E0B; color: #000; font-weight: 900; width: auto; padding: 3px 6px; cursor: pointer; border-radius: 4px; border: none; font-size: 0.58rem; }
        
        .btn-action { background: #6B7280; font-size: 0.5rem; padding: 2px 4px; border-radius: 2px; cursor: pointer; border: none; color: white; display: inline-block; margin-right: 1px; min-width: 25px; }
        .btn-concluir { background: #059669; }
        .btn-excluir { background: #991B1B; }
        .btn-view { background: #0891B2; text-decoration: none; color: white; padding: 2px 4px; border-radius: 2px; font-size: 0.5rem; }

        .table-tools { display: flex; gap: 3px; align-items: center; }
        .btn-tool { font-size: 0.52rem; padding: 2px 5px; width: auto; background: #022C22; border: 1px solid #10B981; color: white; cursor: pointer; border-radius: 3px; }
    </style>
</head>
<body>

<div id="mainContent">
    <div class="container">
        <header style="margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="font-size: 0.9rem; color: #FFF; margin: 0;">üõ°Ô∏è INSPE√á√ÉO PRO V26 - ALERTAS REVISADOS</h1>
        </header>

        <div class="manager-row">
            <div class="card">
                <h2>üè¢ UNIDADE</h2>
                <div style="display: flex; gap: 5px;"><input type="text" id="newUnitName" placeholder="NOME"><button class="btn-add" onclick="addUnit()" style="width: 40px;">ADD</button></div>
                <div id="unitList" class="tag-list"></div>
            </div>
            <div class="card">
                <h2>üõ†Ô∏è ATIVIDADE</h2>
                <div style="display: flex; gap: 5px;"><input type="text" id="newActivityName" placeholder="TIPO"><button class="btn-add" onclick="addActivity()" style="width: 40px;">ADD</button></div>
                <div id="activityList" class="tag-list"></div>
            </div>
        </div>

        <div class="card">
            <h2>‚ûï NOVO REGISTRO</h2>
            <div class="form-group">
                <input type="text" id="equip" placeholder="EQUIPAMENTO">
                <select id="unitSelect"></select>
                <select id="activitySelect"></select>
                <input type="date" id="lastDate">
                <input type="number" id="period" placeholder="DIAS">
                <input type="text" id="rmaf" placeholder="N¬∫ RM/AF">
                <input type="file" id="pdfFile">
                <button class="btn-add" onclick="addItem()">SALVAR</button>
            </div>
        </div>

        <div class="stats-container" id="statsPanel"></div>

        <div class="card" style="padding: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 5px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="btn-sort" onclick="toggleSort()">üîÑ <span id="sortLabel">CADASTRO</span></button>
                    <h2 style="margin:0; font-size: 0.85rem;">üìã MONITORAMENTO GERAL</h2>
                </div>
                <div class="table-tools">
                    <button class="btn-tool" onclick="exportToCSV()">üìä EXCEL</button>
                    <button class="btn-tool" onclick="exportBackup()" style="background:#1E40AF">üíæ BACKUP</button>
                    <button class="btn-tool" onclick="document.getElementById('importFile').click()" style="background:#5B21B6">üìÇ RESTAURAR</button>
                    <input type="file" id="importFile" style="display:none" onchange="importBackup(this)">
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">EQUIPAMENTO<br><input type="text" id="f0" onkeyup="saveAndRender()" class="filter-row"></th>
                        <th style="width: 10%;">UNID.<br><input type="text" id="f1" onkeyup="saveAndRender()" class="filter-row"></th>
                        <th style="width: 10%;">ATIV.<br><input type="text" id="f2" onkeyup="saveAndRender()" class="filter-row"></th>
                        <th style="width: 8%;">CAD.<br><input type="text" id="fCad" onkeyup="saveAndRender()" class="filter-row"></th>
                        <th style="width: 8%;">ULT.<br><input type="text" id="fUlt" onkeyup="saveAndRender()" class="filter-row"></th>
                        <th style="width: 8%;">PROX.<br><input type="text" id="fProx" onkeyup="saveAndRender()" class="filter-row"></th>
                        <th style="width: 8%;">STATUS<br><input type="text" id="f3" onkeyup="saveAndRender()" class="filter-row"></th>
                        <th style="width: 5%;">ANX</th>
                        <th style="width: 10%;">RM/AF<br><input type="text" id="f4" onkeyup="saveAndRender()" class="filter-row"></th>
                        <th style="width: 8%;">A√á√ÉO</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('inspections_v26')) || [];
    let units = JSON.parse(localStorage.getItem('units_v26')) || ["GERAL"];
    let acts = JSON.parse(localStorage.getItem('acts_v26')) || ["INSPE√á√ÉO"];
    let currentSort = "ORIGINAL";

    function toggleSort() {
        currentSort = (currentSort === "ORIGINAL") ? "VENCIMENTO" : "ORIGINAL";
        document.getElementById('sortLabel').innerText = (currentSort === "ORIGINAL") ? "CADASTRO" : "VENCIMENTO";
        saveAndRender();
    }

    function renderManagers() {
        localStorage.setItem('units_v26', JSON.stringify(units));
        localStorage.setItem('acts_v26', JSON.stringify(acts));
        const ul = document.getElementById('unitList'), al = document.getElementById('activityList');
        const us = document.getElementById('unitSelect'), as = document.getElementById('activitySelect');
        ul.innerHTML = al.innerHTML = '';
        us.innerHTML = '<option value="">UNID...</option>';
        as.innerHTML = '<option value="">ATIV...</option>';
        units.forEach(u => {
            ul.innerHTML += `<div class="tag">${u} <button onclick="delUnit('${u}')" style="background:none; border:none; color:#EF4444; cursor:pointer;">‚úï</button></div>`;
            us.innerHTML += `<option value="${u}">${u}</option>`;
        });
        acts.forEach(a => {
            al.innerHTML += `<div class="tag">${a} <button onclick="delAct('${a}')" style="background:none; border:none; color:#EF4444; cursor:pointer;">‚úï</button></div>`;
            as.innerHTML += `<option value="${a}">${a}</option>`;
        });
    }

    function addUnit() { const v = document.getElementById('newUnitName').value.trim().toUpperCase(); if(v){ units.push(v); renderManagers(); } document.getElementById('newUnitName').value=''; }
    function delUnit(u) { units = units.filter(i => i !== u); renderManagers(); }
    function addActivity() { const v = document.getElementById('newActivityName').value.trim().toUpperCase(); if(v){ acts.push(v); renderManagers(); } document.getElementById('newActivityName').value=''; }
    function delAct(a) { acts = acts.filter(i => i !== a); renderManagers(); }

    async function addItem() {
        const file = document.getElementById('pdfFile').files[0];
        const item = {
            id: Date.now(),
            name: document.getElementById('equip').value.toUpperCase(),
            unit: document.getElementById('unitSelect').value,
            act: document.getElementById('activitySelect').value,
            last: document.getElementById('lastDate').value,
            created: new Date().toISOString().split('T')[0],
            period: parseInt(document.getElementById('period').value),
            rmaf: document.getElementById('rmaf').value.toUpperCase(),
            anexo: file ? await toB64(file) : null
        };
        if(!item.name || !item.last || !item.period) return alert("PREENCHA OS CAMPOS!");
        db.push(item); saveAndRender();
        document.getElementById('equip').value = ''; document.getElementById('rmaf').value = '';
    }

    function saveAndRender() {
        localStorage.setItem('inspections_v26', JSON.stringify(db));
        const body = document.getElementById('inventoryBody');
        const f = [
            document.getElementById('f0').value.toLowerCase(), document.getElementById('f1').value.toLowerCase(),
            document.getElementById('f2').value.toLowerCase(), document.getElementById('f3').value.toLowerCase(),
            document.getElementById('f4').value.toLowerCase(), document.getElementById('fCad').value.toLowerCase(),
            document.getElementById('fUlt').value.toLowerCase(), document.getElementById('fProx').value.toLowerCase()
        ];
        
        let cVenc = 0, cRoxo = 0, cVerm = 0, cLaran = 0, cAmar = 0, cOk = 0;
        let displayDb = [...db];
        
        if(currentSort === "VENCIMENTO") {
            displayDb.sort((a,b) => {
                const nA = new Date(a.last); nA.setDate(nA.getDate() + a.period);
                const nB = new Date(b.last); nB.setDate(nB.getDate() + b.period);
                return nA - nB;
            });
        } else { displayDb.sort((a,b) => a.id - b.id); }

        body.innerHTML = '';
        displayDb.forEach(i => {
            const nxt = new Date(i.last); nxt.setDate(nxt.getDate() + i.period);
            const today = new Date().setHours(0,0,0,0);
            const diff = Math.ceil((nxt - today)/86400000);
            
            let statusTxt = "", sc = "";

            if(diff <= 0) { 
                statusTxt = "VENCIDO"; sc = "aviso-vencido"; cRoxo++;
            } else if(diff <= 15) {
                statusTxt = diff + "D"; sc = "aviso-vermelho"; cVerm++;
            } else if(diff <= 30) {
                statusTxt = diff + "D"; sc = "aviso-laranja"; cLaran++;
            } else if(diff <= 60) {
                statusTxt = diff + "D"; sc = "aviso-amarelo"; cAmar++;
            } else {
                statusTxt = diff + "D"; sc = "status-ok"; cOk++;
            }

            const dtC = new Date(i.created).toLocaleDateString('PT-BR');
            const dtU = new Date(i.last).toLocaleDateString('PT-BR');
            const dtP = nxt.toLocaleDateString('PT-BR');

            if(i.name.toLowerCase().includes(f[0]) && i.unit.toLowerCase().includes(f[1]) && 
               i.act.toLowerCase().includes(f[2]) && statusTxt.toLowerCase().includes(f[3]) && 
               (i.rmaf||"").toLowerCase().includes(f[4]) && dtC.includes(f[5]) && 
               dtU.includes(f[6]) && dtP.includes(f[7])) {
                
                body.innerHTML += `<tr>
                    <td><b>${i.name}</b></td><td>${i.unit}</td><td>${i.act}</td><td>${dtC}</td><td>${dtU}</td><td>${dtP}</td>
                    <td><span class="status ${sc}">${statusTxt}</span></td>
                    <td>${i.anexo ? `<a href="${i.anexo}" target="_blank" class="btn-view">V</a>` : '-'}</td>
                    <td>${i.rmaf || "-"}</td>
                    <td style="white-space: nowrap;">
                        <button onclick="conclude(${i.id})" class="btn-action btn-concluir">OK</button>
                        <button onclick="delItem(${i.id})" class="btn-action btn-excluir">EX</button>
                    </td>
                </tr>`;
            }
        });

        document.getElementById('statsPanel').innerHTML = `
            <div class="stat-box" style="background: var(--status-purple)">üíú VENCIDO: ${cRoxo}</div>
            <div class="stat-box" style="background: var(--status-red)">‚ù§Ô∏è < 15 DIAS: ${cVerm}</div>
            <div class="stat-box" style="background: var(--status-orange)">üß° 16-30 DIAS: ${cLaran}</div>
            <div class="stat-box" style="background: var(--status-yellow); color: #000">üíõ 31-60 DIAS: ${cAmar}</div>
            <div class="stat-box" style="background: var(--status-green)">üíö OK (>60): ${cOk}</div>
        `;
    }

    function exportToCSV() {
        let csv = "EQUIPAMENTO;UNIDADE;ATIVIDADE;CADASTRO;ULTIMA;PROXIMA;RM/AF\n";
        db.forEach(i => {
            const nxt = new Date(i.last); nxt.setDate(nxt.getDate() + i.period);
            csv += `${i.name};${i.unit};${i.act};${i.created};${i.last};${nxt.toISOString().split('T')[0]};${i.rmaf || ""}\n`;
        });
        const b = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const l = document.createElement("a"); l.href = URL.createObjectURL(b);
        l.setAttribute("download", "INSPECOES_V26.csv"); l.click();
    }

    function exportBackup() {
        const b = { db, units, acts, v: "V26" };
        const blob = new Blob([JSON.stringify(b)], { type: 'application/json' });
        const l = document.createElement("a"); l.href = URL.createObjectURL(blob);
        l.setAttribute("download", `BACKUP_V26.json`); l.click();
    }

    function importBackup(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                db = data.db || []; units = data.units || ["GERAL"]; acts = data.acts || ["INSPE√á√ÉO"];
                renderManagers(); saveAndRender();
                alert("DADOS RESTAURADOS!");
            } catch (err) { alert("ERRO NO BACKUP!"); }
        };
        reader.readAsText(file);
    }

    function conclude(id) { if(confirm("CONFIRMAR?")) { const idx = db.findIndex(i => i.id === id); db[idx].last = new Date().toISOString().split('T')[0]; saveAndRender(); } }
    function delItem(id) { if(confirm("EXCLUIR?")) { db = db.filter(x => x.id !== id); saveAndRender(); } }
    const toB64 = f => new Promise(r => { const fr = new FileReader(); fr.readAsDataURL(f); fr.onload = () => r(fr.result); });
    
    renderManagers();
    saveAndRender();
</script>
</body>
</html>